<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>形象进度</title>
    <link rel="stylesheet" href="/css/release.css">
    <link rel="stylesheet" href="/css/list.css">

    <script src="/js/lib/requirejs/require.js"></script>
    <script src="/js/lib/requirejs/main.js"></script>
    <style>
        .form_double_row .row_right span {
            height: auto !important;
        }

        .ms-controller {
            visibility: hidden;
        }

        .must {
            color: red;
            font-size: 20px;
            position: relative;
            left: 5px;
            top: 3px;
        }

        nav li {
            width: 50% !important;
        }
    </style>

</head>
<body ms-controller="root" class="ms-controller" style="height: 860px;overflow: hidden;">

<div class="release_product pr3">
    <div class="main-contain" style="height: 830px;overflow: hidden;">
        <div class="title">新增设备投入&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(每个月10号前填报上个月的)</div>
        <div class="form" style="margin-top: 20px;">
            <div class="form_row">
                <div style="clear: both;"></div>
                <p class="row_left">公司名称：</p>

                <div class="row_right" >
                   <p>{{detail.company}}</p>
                </div>
            </div>
            <div class="form_row">
                <div style="clear: both;"></div>
                <p class="row_left">项目名称：</p>

                <div class="row_right" >
                   <p>{{detail.name}}</p>
                </div>
            </div>
            <div class="form_row">
                <div style="clear: both;"></div>
                <p class="row_left">月份</p>

                <div class="row_right" >
                    <input style="color: #71686885;" id="month"readonly type="text" placeholder="" >
                </div>
            </div>
            <div class="form_row">
                <div style="clear: both;"></div>
                <p class="row_left">投入金额（必填）</p>
                <div class="row_right">
                    <input id="invested" type="number" placeholder="单位（万元）">
                </div>
            </div>
            <div class="form_double_row">
                <div style="clear: both;"></div>

                <p class="row_left">发票照片（必填）</p>

                <div class="row_right" style="margin-top: 5px;">
                    <div id="fileUploadContent" class="fileUploadContent">
                        <div class="uploadBts">
                            <div style="width: 100px;height: 100px;" :for="(index,el) in img">
                                <img :attr="{src:el.img_url}" width="100" height="100" alt="">

                                <div class="remove_img" :click="removeImg(index)">
                                    <i class="fa fa-trash-o fa-lg"></i>
                                </div>
                            </div>
                            <div class="chooseImg selectFileBt">
                                <img src="/img/icon/icon_add.png" alt="">
                                <span style="font-size: 12px;">点击添加图片</span>
                            </div>

                        </div>
                        <div class="box"></div>
                    </div>
                </div>
            </div>
            <div class="form_tips">
                <div style="clear: both;"></div>
                <p class="row_left"></p>

                <div class="row_right" style="margin-top: 20px;font-size: 12px;">支持jpg、gif、png图片格式</div>
            </div>
            <br/>

            <div class="form_row" style="margin-top: 50px;">
                <div class="next2" :visible="showBtn.flag == 1" :click="submit()">完成</div>
            </div>
            <div class="form_row">
                <div class="next2" style="background:#dddddd;" :click="goBack()">返回</div>
            </div>
            <div class="form_row">
                <div style="text-align: center" :visible="showBtn.flag == 0" >{{showBtn.errmsg}}</div>
            </div>
        </div>


    </div>
</div>
<script>


    var model;
    require(["baseUiIndex.css", "font-awesome.css"]);
    require(['avalon'], function (avalon) {
        model = avalon.define({
            $id: "root",
            $uid:"",
            detail: {
                "company":"",
                "name":"",
                "date":"",
                "invested": "",
                "img" :[]
            },
            "img": [],
            showBtn: {
                "flag": "",
                "errmsg":""
            },
            submit: function () {
                var detail = model.detail;

                for (var i in model.img){
                    detail.img.push(model.img[i].img_url);
                }
                var url = "/trace/facility/add";
                detail.url = url;
                detail.date=document.getElementById('month').value;
                detail.invested=document.getElementById('invested').value;
                $.ajaxPost(detail, function (data) {
                    alert("操作成功");
                    redict_iframe("/trace/t/#facility/facility_list.html?pid="+model.detail.pid);
                });
            },
            month: function() {
                var date = new Date();
                var year = date.getFullYear();
                var month = date.getMonth();
                var day = date.getDate();
                if(day <= 10)
                    if(month == 0)
                        document.getElementById('month').value = year-1 +"年12月";
                    else
                        document.getElementById('month').value = year+"年"+month+"月";
                else
                    document.getElementById('month').value = year+"年"+month+1+"月";
            },
            getLatest: function(){
                $.ajaxGet({
                    url: "/trace/facility/addAuth",
                    pid:model.detail.pid,
                    uid:model.uid
                }, function (data) {
                    if(data.res) {
                        model.detail.company = data.res.company;
                        model.detail.name = data.res.name;
                        model.showBtn.flag = 1;
                    }
                    else{
                        model.showBtn.flag = 0;
                        model.showBtn.errmsg = "无权限，请到您管理的项目下填报！";
                    }
                });
            },
            goBack: function(){
                redict_iframe("/trace/t/#facility/facility_list.html?pid="+model.detail.pid);
            },
            removeImg: function (index) {
                if (!confirm("确认删除吗")) return;

                for (var i in model.img) {
                    if (i == index) {
                        model.img.splice(index, 1);
                    }
                }
            }
        });
        model.month();
        model.detail.pid = getRequest().pid;
        model.uid = window.sessionStorage.getItem('uid');
        model.getLatest();
    });

    //图片上传部分
    require(["jquery.fileUpload"], function () {
        $(function () {
            $("#fileUploadContent").initUpload({
                "uploadUrl": "/trace/system/img/upload",//上传文件信息地址
                //"size":350,//文件大小限制，单位kb,默认不限制
                "maxFileNumber": 5,//文件个数限制，为整数
                "filelSavePath": "",//文件上传地址，后台设置的根目录
                "beforeUpload": beforeUploadFun,//在上传前执行的函数
                "onUpload": onUploadFun,//在上传后执行的函数
                "autoCommit": true,//文件是否自动上传
                "fileType": ['png', 'jpg', 'docx', 'doc','JPG','PNG']//文件类型限制，默认不限制，注意写的是文件后缀
            });
        });
        $(function () {
            $('#aside').height($(window).height());
        })
    });
    function beforeUploadFun() {
    }
    function onUploadFun(opt, data) {
        uploadTools.uploadError(opt);//显示上传错误
        uploadTools.uploadSuccess(opt);//显示上传成功
    }

</script>
</body>

</html>